import{createElement as t}from"../../external/preact/dist/preact.js";import{TxVariants as e}from"../tx-variants.js";import{UIElement as n}from"../internal/UIElement/UIElement.js";import r from"../../core/Errors/SRPanelProvider.js";import i from"../internal/RedirectButton/RedirectButton.js";import o,{ERROR as s}from"../../core/Errors/AdyenCheckoutError.js";import{PasskeyService as a}from"./services/PasskeyService.js";import{authorizeEnrollment as p}from"./services/authorizeEnrollment.js";import{authorizePayment as l}from"./services/authorizePayment.js";import d from"./components/StoredPayment/StoredPayment.js";import c from"./components/Enrollment/Enrollment.js";function h(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),r.forEach(function(e){h(t,e,n[e])})}return t}function m(t,e){return e=null!=e?e:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):function(t){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e.push.apply(e,n)}return e}(Object(e)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}),t}function u(t,e){if(null==t)return{};var n,r,i=function(t,e){if(null==t)return{};var n,r,i={},o=Object.keys(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(r=0;r<o.length;r++)n=o[r],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}class v extends n{get isValid(){var t;return!(this.props._isAdyenHosted&&!this.props.storedPaymentMethodId)||!!(null===(t=this.state)||void 0===t?void 0:t.isValid)}get additionalInfo(){var t,e;return this.props.storedPaymentMethodId?this.props.i18n.get("paybybankpix.storedPayment.additionalLabel",{values:{receiver:null===(e=this.props)||void 0===e||null===(t=e.payByBankPixDetails)||void 0===t?void 0:t.receiver}}):""}get icon(){var t,e;return this.props.storedPaymentMethodId?this.resources.getImage({parentFolder:`${v.type}/`})(null===(e=this.props)||void 0===e||null===(t=e.payByBankPixDetails)||void 0===t?void 0:t.ispb):super.icon}async isAvailable(){const t=await this.passkeyService.getWebAuthnUnsupportedReason();if(t)return Promise.reject(new o(s,t));if(!this.props._isAdyenHosted)return Promise.resolve();try{if(await this.passkeyService.initialize(),this.props.storedPaymentMethodId){return await this.passkeyService.canUseStoredCredential()?Promise.resolve():Promise.reject(new o("ERROR","The stored payment method is not available on this device"))}return Promise.resolve()}catch(t){return Promise.reject(t instanceof Error?null==t?void 0:t.message:"Unknown error")}}handleAction(t,e={}){const n=this.core.createFromAction(t,m(y({},this.elementRef.props,e),{onAdditionalDetails:this.handleAdditionalDetails}));return n?(this.unmount(),n.isAvailable().then(()=>{n.mount(this._node)}),n):null}formatData(){if(!this.props._isAdyenHosted)return{paymentMethod:{type:e.paybybank_pix}};const t=null==this.props.storedPaymentMethodId;return y({paymentMethod:y({type:e.paybybank_pix},this.state.data)},t?{storePaymentMethod:!0}:{})}componentToRender(){var e,n,o;return this.props._isAdyenHosted?t(r,{srPanel:this.srPanel},null!=this.props.storedPaymentMethodId?t(d,{txVariant:v.type,type:this.props.type,clientKey:this.props.clientKey,amount:this.props.amount,enrollmentId:null===(e=this.props.paymentMethodData)||void 0===e?void 0:e.enrollmentId,initiationId:null===(n=this.props.paymentMethodData)||void 0===n?void 0:n.initiationId,setComponentRef:this.setComponentRef,onPay:this.payWithStoredPayment,onAuthorize:this.authorizePayment}):t(c,{onError:this.handleError,txVariant:v.type,type:this.props.type,clientKey:this.props.clientKey,enrollmentId:null===(o=this.props.paymentMethodData)||void 0===o?void 0:o.enrollmentId,countdownTime:this.props.countdownTime,onEnroll:this.authorizeEnrollment,issuers:this.props.issuers,payButton:this.payButton,onChange:this.onIssuerSelected,onSubmitAnalytics:this.submitAnalytics,setComponentRef:this.setComponentRef})):t(r,{srPanel:this.srPanel},t(i,{showPayButton:this.props.showPayButton,name:this.displayName,label:this.props.i18n.get("paybybankpix.redirectBtn.label"),amount:this.props.amount,payButton:this.payButton,onSubmit:this.submit,ref:t=>{this.componentRef=t}}))}constructor(t,e){var n,r;super(t,e),h(this,"passkeyService",void 0),h(this,"onIssuerSelected",async t=>{try{const{data:e={}}=t;if(!e.issuer)return;const n=await this.passkeyService.captureRiskSignalsEnrollment(),{deviceId:r}=n,i=u(n,["deviceId"]);this.setState(m(y({},t),{data:m(y({},e),{riskSignals:i,deviceId:r})}))}catch(t){const e=t instanceof Error?t.message:"Unknown error in the onIssuerSelected";this.handleError(t instanceof o?t:new o(s,e))}}),h(this,"authorizeEnrollment",async t=>{try{var e;const n=await this.passkeyService.createCredentialForEnrollment(t),r={enrollmentId:null===(e=this.props.paymentMethodData)||void 0===e?void 0:e.enrollmentId,fidoAssertion:n},{redirectResult:i}=await p({enrollment:r,clientKey:this.props.clientKey,loadingContext:this.props.loadingContext});this.handleAdditionalDetails({data:{details:{redirectResult:i}}})}catch(t){const e=t instanceof Error?t.message:"Unknown error in the authorizeEnrollment";this.handleError(t instanceof o?t:new o(s,e))}}),h(this,"payWithStoredPayment",async()=>{try{const t=await this.passkeyService.captureRiskSignalsAuthentication(),{deviceId:e}=t,n=u(t,["deviceId"]);this.state=y({},this.state,{data:{storedPaymentMethodId:this.props.storedPaymentMethodId,riskSignals:n,deviceId:e}}),super.submit()}catch(t){const e=t instanceof Error?t.message:"Unknown error in the payWithStoredPayment";this.handleError(t instanceof o?t:new o(s,e))}}),h(this,"authorizePayment",async t=>{try{var e,n;const r=await this.passkeyService.authenticateWithCredential(t),i={enrollmentId:null===(e=this.props.paymentMethodData)||void 0===e?void 0:e.enrollmentId,initiationId:null===(n=this.props.paymentMethodData)||void 0===n?void 0:n.initiationId,fidoAssertion:r},{redirectResult:o}=await l({payment:i,clientKey:this.props.clientKey,loadingContext:this.props.loadingContext});this.handleAdditionalDetails({data:{details:{redirectResult:o}}})}catch(t){const e=t instanceof Error?t.message:"Unknown error in the authorizePayment";this.handleError(t instanceof o?t:new o(s,e))}});const i=this.props.storedPaymentMethodId?null===(r=this.props)||void 0===r||null===(n=r.payByBankPixDetails)||void 0===n?void 0:n.deviceId:this.props.deviceId;this.passkeyService=new a({environment:this.props.environment,deviceId:i},this.analytics),this.props._isAdyenHosted&&this.passkeyService.initialize()}}h(v,"type",e.paybybank_pix),h(v,"TIMEOUT_MINUTES",1),h(v,"defaultProps",{showPayButton:!0,_isAdyenHosted:(()=>{try{return new URL(window.location.href).hostname.endsWith(".adyen.com")}catch(t){return!1}})(),countdownTime:v.TIMEOUT_MINUTES});export{v as default};
//# sourceMappingURL=PayByBankPix.js.map
