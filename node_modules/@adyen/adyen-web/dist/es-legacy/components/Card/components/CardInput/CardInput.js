import{createElement as e,Fragment as r}from"../../../../external/preact/dist/preact.js";import{useRef as t,useMemo as o,useState as n,useCallback as s,useEffect as a}from"../../../../external/preact/hooks/dist/hooks.js";import i from"../../../internal/SecuredFields/SFP/SecuredFieldsProvider.js";import l from"./defaultProps.js";import{AddressModeOptions as d}from"./types.js";import{DATE_POLICY_REQUIRED as u,CVC_POLICY_REQUIRED as c,ENCRYPTED_CARD_NUMBER as m}from"../../../internal/SecuredFields/lib/constants.js";import{cardInputValidationRules as p,cardInputFormatters as y,getRuleByNameAndMode as f}from"./validate.js";import b from"../../../internal/SecuredFields/binLookup/extensions.js";import h from"../../../../utils/useForm/useForm.js";import{handlePartialAddressMode as g,extractPropsForSFP as S,getLayout as N,extractPropsForCardFields as A}from"./utils.js";import v from"../../../internal/Address/Specifications.js";import{StoredCardFieldsWrapper as j}from"./components/StoredCardFieldsWrapper.js";import{CardFieldsWrapper as F}from"./components/CardFieldsWrapper.js";import{getAutoJumpHandler as O,getFocusHandler as C,getAddressHandler as w}from"./handlers.js";import P from"../../../../_virtual/index.js";import{getPartialAddressValidationRules as k}from"../../../internal/Address/validate.js";import B from"../../../../core/Context/useImage.js";import{getArrayDifferences as E}from"../../../../utils/arrayUtils.js";import R from"../../../internal/FormInstruction/FormInstruction.js";import{PREFIX as x}from"../../../internal/Icon/constants.js";import I from"./useSRPanelForCardInputErrors.js";import V from"../Fastlane/FastlaneSignup.js";import{fieldTypeToSnakeCase as D}from"../../../internal/SecuredFields/utils.js";import{getErrorMessageFromCode as q}from"../../../../core/Errors/utils.js";import{SF_ErrorCodes as M}from"../../../../core/Errors/constants.js";import{usePrevious as _}from"../../../../utils/hookUtils.js";import{AnalyticsInfoEvent as L,InfoEventType as T,UiTarget as K}from"../../../../core/Analytics/events/AnalyticsInfoEvent.js";function U(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function H(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{},o=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.forEach(function(r){U(e,r,t[r])})}return e}function z(e,r){return r=null!=r?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):function(e){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r.push.apply(r,t)}return r}(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}),e}const W=l=>{var U,W;const $=t(null),G=t(!1),J=B(),Q=t(null),X=e=>{Q.current=e},Y=t({});Object.keys(Y.current).length||l.setComponentRef(Y.current);const Z=t(0),ee=t(!1),re=o(()=>new v(l.specifications),[l.specifications]);Y.current.sfp=$;const[te,oe]=n("ready"),[ne,se]=n({}),[ae,ie]=n(H({},l.holderNameRequired&&{holderName:!1}));var le;const[de,ue]=n(H({},l.hasHolderName&&{holderName:null!==(le=l.data.holderName)&&void 0!==le?le:""})),[ce,me]=n(""),[pe,ye]=n(!1),[fe,be]=n(u),[he,ge]=n(c),[Se,Ne]=n(null),[Ae,ve]=n([]),[je,Fe]=n(l.storedPaymentMethodId?l.brand:""),Oe=l.billingAddressMode!==d.none&&l.billingAddressRequired,Ce=g(l.billingAddressMode),we=t(Ce&&(null===(W=l.data)||void 0===W||null===(U=W.billingAddress)||void 0===U?void 0:U.country)),[Pe,ke]=n(!1),[Be,Ee]=n(Oe?l.data.billingAddress:null),[Re,xe]=n(!1),[Ie,Ve]=n(""),[De,qe]=n({value:null}),[Me,_e]=n(null),[Le,Te]=n("card"),[Ke,Ue]=n(!1),{handleChangeFor:He,triggerValidation:ze,data:We,valid:$e,errors:Ge,setSchema:Je,setData:Qe,setValid:Xe,setErrors:Ye}=h({schema:[],defaultData:l.data,formatters:y,rules:p}),Ze=!!Object.keys(l.installmentOptions).length&&"debit"!==l.fundingSource;var er;const rr=null===(er=l.showInstallmentAmounts)||void 0===er||er,tr="kr"===(null!=Se?Se:l.countryCode),or=l.configuration.koreanAuthenticationRequired&&tr,nr=Re&&"auto"===l.configuration.socialSecurityNumberMode||"show"===l.configuration.socialSecurityNumberMode,sr=(e,r)=>{l.onFocus({fieldType:e,event:r})},ar=(e,r)=>{l.onBlur({fieldType:e,event:r})},ir=s(e=>{Te(e.brand),l.onBrand(e)},[]),lr=C(me,sr,ar),dr=()=>N(H({props:l,showKCP:or,showBrazilianSSN:nr},l.billingAddressRequired&&{countrySpecificSchemas:re.getAddressSchemaForCountry(null==Be?void 0:Be.country),billingAddressRequiredFields:l.billingAddressRequiredFields})),ur=s(e=>{const r="webInternalElement"!==e.fieldType?e.fieldType:e.name;_e(r)},[]),cr=w(Qe,Xe,Ye),mr=O(ee,$,dr()),pr=s(e=>{yr(e)},[Ke,Ue]),yr=e=>{e.status&&("loading"==e.status?Ue(!1):Ue(!0))},fr=o(()=>b(l,{sfp:$},{dualBrandSelectElements:Ae,setDualBrandSelectElements:ve,setSelectedBrandValue:Fe,issuingCountryCode:Se,setIssuingCountryCode:Ne},Z),[Ae,Se]);Y.current.showValidation=()=>{G.current=!0,null==gr||gr(),$.current.showValidation(),ze(["holderName","socialSecurityNumber","taxNumber"]),(null==Q?void 0:Q.current)&&Q.current.showValidation()},Y.current.processBinLookupResponse=(e,r)=>{fr.processBinLookup(e,r)},Y.current.setStatus=oe,a(()=>(Y.current.setFocusOn=$.current.setFocusOn,Y.current.updateStyles=$.current.updateStyles,Y.current.handleUnsupportedCard=$.current.handleUnsupportedCard,()=>{$.current.destroy()}),[]),a(()=>{const e=[...l.hasHolderName?["holderName"]:[],...nr?["socialSecurityNumber"]:[],...or?["taxNumber"]:[],...Oe?["billingAddress"]:[]];Je(e)},[l.hasHolderName,nr,or]),a(()=>{var e;ue(z(H({},de),{holderName:null!==(e=We.holderName)&&void 0!==e?e:"",taxNumber:We.taxNumber})),Ve(We.socialSecurityNumber),Oe&&Ee(H({},We.billingAddress)),ie(z(H({},ae),{holderName:!l.holderNameRequired||$e.holderName,socialSecurityNumber:!!$e.socialSecurityNumber&&$e.socialSecurityNumber,taxNumber:!!$e.taxNumber&&$e.taxNumber,billingAddress:!!$e.billingAddress&&$e.billingAddress}));const r=!!Ge.billingAddress&&Object.entries(Ge.billingAddress).reduce((e,[,r])=>e||null!=r,!1);se(z(H({},ne),{holderName:l.holderNameRequired&&Ge.holderName?Ge.holderName:null,socialSecurityNumber:nr&&Ge.socialSecurityNumber?Ge.socialSecurityNumber:null,taxNumber:or&&Ge.taxNumber?Ge.taxNumber:null,billingAddress:Oe&&r?Ge.billingAddress:null}))},[We,$e,Ge]);const{sortedErrorList:br,previousSortedErrors:hr,clearSRPanel:gr}=I({errors:ne,props:l,isValidating:G,retrieveLayout:dr,specifications:re,billingAddress:Be,sfp:$});a(()=>{if(br){const e=E(br,hr,"field");null==e||e.forEach(e=>{const r=new L({component:l.type,type:T.validationError,target:D(e.field),validationErrorCode:e.errorCode,validationErrorMessage:q(e.errorCode,M)});l.onSubmitAnalytics(r)})}},[br]),a(()=>{const e=ae.holderName,r=pe,t=!Oe||ae.billingAddress,o=!or||!!ae.taxNumber&&!!ae.encryptedPassword,n=!nr||!!ae.socialSecurityNumber,s=r&&e&&t&&o&&n,a=$.current.mapErrorsToValidationRuleResult(),i=H({},ne,a);l.onChange({data:de,valid:ae,errors:i,isValid:s,billingAddress:Be,selectedBrandValue:je,storePaymentMethod:Pe,socialSecurityNumber:Ie,installments:De})},[de,ae,ne,je,Pe,De]),a(()=>{if(Ae.length>0&&Ae){const e=Ae.map(e=>e.id),r=e[0],t=e.toString(),o=new L({component:l.type,type:T.displayed,target:K.dualBrandButton,brand:r,configData:{dualBrands:t}});l.onSubmitAnalytics(o)}},[Ae]);const Sr=_(je);a(()=>{if((null==Sr?void 0:Sr.length)&&(null==je?void 0:je.length)){const e=new L({component:l.type,type:T.selected,target:K.dualBrandButton,brand:je});l.onSubmitAnalytics(e)}},[je]);const Nr=l.storedPaymentMethodId?j:F;return e(r,null,e(i,z(H({ref:$},S(l)),{styles:H({},l.styles),koreanAuthenticationRequired:l.configuration.koreanAuthenticationRequired,hasKoreanFields:!(!l.configuration.koreanAuthenticationRequired||"kr"!==l.countryCode),onChange:(e,r)=>{if(e.autoCompleteName){if(!l.hasHolderName)return;const r=f("holderName","blur")(e.autoCompleteName)?e.autoCompleteName:null;return void(r&&(Qe("holderName",r),Xe("holderName",!0),Ye("holderName",null)))}l.autoFocus&&Z.current>0&&"handleOnFieldValid"===(null==r?void 0:r.event)&&(null==r?void 0:r.fieldType)===m&&e.valid.encryptedCardNumber&&mr(),ue(H({},de,e.data)),se(H({},ne,e.errors)),ie(H({},ae,e.valid)),ye(e.isSfpValid),ge(e.cvcPolicy),xe(e.showSocialSecurityNumber),be(e.expiryDatePolicy)},onBrand:ir,onFocus:lr,onStateUpdate:pr,type:l.brand,disableIOSArrowKeys:l.disableIOSArrowKeys?ur:null,render:({setRootNode:r,setFocusOn:t},o)=>{var n;return e("div",{ref:r,className:P({"adyen-checkout__card-input":!0,"adyen-checkout-card-input__wrapper":!0,[`adyen-checkout__card-input--${null!==(n=l.fundingSource)&&void 0!==n?n:"credit"}`]:!0,"adyen-checkout__card-input--loading":"loading"===te}),role:"form"},Ke&&e(R,null),e(Nr,z(H({},A(l)),{data:de,valid:ae,errors:ne,handleChangeFor:He,focusedElement:ce,setFocusOn:t,sfpState:o,cvcPolicy:he,hasInstallments:Ze,showAmountsInInstallments:rr,handleInstallments:qe,brandsIcons:l.brandsIcons,formData:We,formErrors:Ge,formValid:$e,expiryDatePolicy:fe,dualBrandSelectElements:Ae,extensions:fr,selectedBrandValue:je,showKCP:or,showBrazilianSSN:nr,socialSecurityNumber:Ie,handleOnStoreDetails:ke,setAddressRef:X,billingAddress:Be,billingAddressValidationRules:Ce&&k(we.current),partialAddressSchema:Ce,handleAddress:cr,onAddressLookup:l.onAddressLookup,onAddressSelected:l.onAddressSelected,addressSearchDebounceMs:l.addressSearchDebounceMs,iOSFocusedField:Me,onFieldFocusAnalytics:sr,onFieldBlurAnalytics:ar})))}})),l.fastlaneConfiguration&&e(V,z(H({},l.fastlaneConfiguration),{currentDetectedBrand:Le,onChange:l.onChange,onSubmitAnalytics:l.onSubmitAnalytics,type:l.type})),Ke&&l.showPayButton&&l.payButton({status:te,variant:l.isPayButtonPrimaryVariant?"primary":"secondary",icon:J({imageFolder:"components/"})(`${x}lock`)}))};W.defaultProps=l;export{W as default};
//# sourceMappingURL=CardInput.js.map
