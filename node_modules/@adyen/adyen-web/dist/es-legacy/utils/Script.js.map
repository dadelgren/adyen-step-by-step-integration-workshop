{"version":3,"file":"Script.js","sources":["../../../src/utils/Script.ts"],"sourcesContent":["import AdyenCheckoutError from '../core/Errors/AdyenCheckoutError';\nimport { AnalyticsInfoEvent, InfoEventType } from '../core/Analytics/events/AnalyticsInfoEvent';\nimport type { IAnalytics } from '../core/Analytics/Analytics';\n\ninterface IScript {\n    load(): Promise<void>;\n    remove(): void;\n}\n\ninterface IScriptProps {\n    src: string;\n    component: string;\n    analytics: IAnalytics;\n    node?: string;\n    attributes?: Partial<HTMLScriptElement>;\n    dataAttributes?: Record<string, string | undefined>;\n}\n\n// Returns Base URL of the resource without any query parameters (e.g. merchant ID, token, etc). Used for Analytics\nfunction getBaseURL(src: string): string {\n    const url = new URL(src);\n    return url.origin + url.pathname;\n}\n\nclass Script implements IScript {\n    private readonly src: string;\n    private readonly component: string;\n    private readonly node: string;\n    private readonly attributes: Partial<HTMLScriptElement>;\n    private readonly dataAttributes: Record<string, string | undefined>;\n    private readonly analytics: IAnalytics;\n    private readonly baseUrl: string;\n\n    private script: HTMLScriptElement;\n    private loadPromise: Promise<void> | null = null;\n    private rejectLoadPromise: (reason?: any) => void | null = null;\n\n    public static readonly RETRY_DELAY = 1000;\n    public static readonly MAX_NUMBER_OF_RETRIES = 3;\n\n    constructor({ src, component, node = 'body', attributes, dataAttributes, analytics }: IScriptProps) {\n        this.src = src;\n        this.component = component;\n        this.node = node;\n        this.attributes = attributes;\n        this.dataAttributes = dataAttributes;\n        this.analytics = analytics;\n        this.baseUrl = getBaseURL(this.src);\n    }\n\n    public load = (): Promise<void> => {\n        if (this.loadPromise !== null) {\n            if (process.env.NODE_ENV === 'development') console.warn(`[Warning] script.load called more than once for ${this.src}`);\n            return this.loadPromise;\n        }\n\n        this.loadPromise = new Promise((resolve, reject) => {\n            this.rejectLoadPromise = reject;\n            let attempts = 0;\n\n            this.trackEvent(InfoEventType.sdkDownloadInitiated);\n\n            const loadScriptWithRetry = async (): Promise<void> => {\n                try {\n                    attempts++;\n                    await this.loadScript();\n                    this.trackEvent(InfoEventType.sdkDownloadCompleted);\n                    resolve();\n                } catch (error: unknown) {\n                    if (this.loadPromise === null) {\n                        return;\n                    }\n\n                    this.trackEvent(InfoEventType.sdkDownloadFailed);\n\n                    this.removeScript();\n\n                    if (attempts < Script.MAX_NUMBER_OF_RETRIES) {\n                        setTimeout(() => void loadScriptWithRetry(), Script.RETRY_DELAY);\n                    } else {\n                        this.trackEvent(InfoEventType.sdkDownloadAborted);\n                        this.loadPromise = null;\n                        this.rejectLoadPromise = null;\n                        reject(error);\n                    }\n                }\n            };\n\n            void loadScriptWithRetry();\n        });\n\n        return this.loadPromise;\n    };\n\n    public remove = () => {\n        this.rejectLoadPromise?.(new AdyenCheckoutError('CANCEL', 'Script loading cancelled.'));\n        this.removeScript();\n        this.loadPromise = null;\n    };\n\n    private removeScript() {\n        this.script?.parentNode?.removeChild(this.script);\n        this.script = null;\n    }\n\n    private loadScript(): Promise<void> {\n        return new Promise((resolve, reject) => {\n            const scriptContainer = document.querySelector(this.node);\n\n            if (!scriptContainer) {\n                reject(new AdyenCheckoutError('SCRIPT_ERROR', `Unable to find script container node: ${this.node}`));\n                return;\n            }\n\n            const cleanupListeners = () => {\n                if (!this.script) return;\n                this.script.removeEventListener('load', handleOnLoad);\n                this.script.removeEventListener('error', handleOnError);\n            };\n\n            const handleOnLoad = () => {\n                this.script.setAttribute('data-script-loaded', 'true');\n                cleanupListeners();\n                resolve();\n            };\n\n            const handleOnError = (errorEvent: ErrorEvent) => {\n                cleanupListeners();\n                reject(\n                    new AdyenCheckoutError(\n                        'SCRIPT_ERROR',\n                        `Unable to load script ${this.src}.${errorEvent?.message && `Message: ${errorEvent.message}`}`,\n                        {\n                            cause: errorEvent?.error || errorEvent\n                        }\n                    )\n                );\n            };\n\n            this.script = scriptContainer.querySelector(`script[src=\"${this.src}\"]`);\n\n            // Script element exists in the browser and is already loaded\n            if (this.script?.getAttribute('data-script-loaded')) {\n                resolve();\n                return;\n            }\n\n            // Script element exists in the browser, but it is not loaded yet\n            // Use-case:  Multiple PayPal standalone components being loaded in different parts of the screen.\n            if (this.script) {\n                this.script.addEventListener('load', handleOnLoad);\n                this.script.addEventListener('error', handleOnError);\n                return;\n            }\n\n            // Script element doesn't exist in the browser, so we create it and append to the DOM tree\n            this.script = document.createElement('script');\n\n            Object.assign(this.script, this.attributes);\n            Object.assign(this.script.dataset, this.dataAttributes);\n\n            this.script.src = this.src;\n            this.script.async = true;\n\n            this.script.addEventListener('load', handleOnLoad);\n            this.script.addEventListener('error', handleOnError);\n\n            scriptContainer.appendChild(this.script);\n        });\n    }\n\n    private trackEvent(eventType: InfoEventType) {\n        const event = new AnalyticsInfoEvent({\n            type: eventType,\n            component: this.component,\n            cdnUrl: this.baseUrl\n        });\n        this.analytics?.sendAnalytics(event);\n    }\n}\n\nexport default Script;\n"],"names":["Script","removeScript","_this_script_parentNode","_this_script","this","script","parentNode","removeChild","loadScript","Promise","resolve","reject","scriptContainer","document","querySelector","node","AdyenCheckoutError","cleanupListeners","removeEventListener","handleOnLoad","handleOnError","setAttribute","errorEvent","src","message","cause","error","getAttribute","addEventListener","createElement","Object","assign","attributes","dataset","dataAttributes","async","appendChild","trackEvent","eventType","_this_analytics","event","AnalyticsInfoEvent","type","component","cdnUrl","baseUrl","analytics","sendAnalytics","constructor","_define_property","loadPromise","rejectLoadPromise","load","attempts","InfoEventType","sdkDownloadInitiated","loadScriptWithRetry","sdkDownloadCompleted","sdkDownloadFailed","MAX_NUMBER_OF_RETRIES","setTimeout","RETRY_DELAY","sdkDownloadAborted","remove","_this_rejectLoadPromise","call","url","URL","origin","pathname","getBaseURL"],"mappings":"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"}